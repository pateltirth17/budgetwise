{% extends "base.html" %}

{% block title %}Transactions - BudgetWise AI{% endblock %}

{% block extra_css %}
<style>
    .transactions-container {
        max-width: 1200px;
        margin: 30px auto;
    }
    
    .filters-bar {
        background: white;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .transaction-row {
        background: white;
        padding: 15px;
        margin-bottom: 10px;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        transition: all 0.3s;
    }
    
    .transaction-row:hover {
        transform: translateX(5px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .amount-expense {
        color: #ef4444;
        font-weight: 600;
    }
    
    .amount-income {
        color: #10b981;
        font-weight: 600;
    }
    
    .category-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
    }
</style>
{% endblock %}

{% block content %}
<div class="transactions-container">

    <!-- Heading -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-receipt"></i> Transactions</h2>
        <div>
            <a href="{{ url_for('add_transaction') }}" class="btn btn-primary">
                <i class="bi bi-plus-circle"></i> Add Transaction
            </a>
        </div>
    </div>

    <!-- ✅ Statistics Section -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">Total Spending</h5>
                    <h3 class="text-danger">₹{{ "{:,.2f}".format(total_spending|default(0)) }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">Total Income</h5>
                    <h3 class="text-success">₹{{ "{:,.2f}".format(total_income|default(0)) }}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">Average/Day</h5>
                    <h3 class="text-info">₹{{ "{:,.2f}".format(avg_per_day|default(0)) }}</h3>
                    <small class="text-muted">Over {{ days_range|default(0) }} days</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h5 class="card-title">Transactions</h5>
                    <h3 class="text-primary">{{ total_count|default(0) }}</h3>
                    <small class="text-muted">{{ expense_count|default(0) }} expenses, {{ income_count|default(0) }} income</small>
                </div>
            </div>
        </div>
    </div>

    <!-- ✅ Category Breakdown -->
    {% if category_breakdown %}
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">Category Breakdown</h5>
        </div>
        <div class="card-body">
            <div class="row">
                {% for cat, data in category_breakdown.items() %}
                <div class="col-md-4 mb-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-tag"></i> {{ cat }}</span>
                        <span class="badge bg-primary">
                            ₹{{ "{:,.0f}".format(data.amount) }} ({{ data.count }} items)
                        </span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- ✅ Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="GET" action="{{ url_for('transactions') }}">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label for="category" class="form-label">Category</label>
                        <select class="form-select" id="category" name="category">
                            <option value="">All Categories</option>
                            {% for cat in categories %}
                            <option value="{{ cat }}" {% if cat == selected_category %}selected{% endif %}>
                                {{ cat }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="date_from" class="form-label">From Date</label>
                        <input type="date" class="form-control" id="date_from" name="date_from" 
                               value="{{ selected_date_from }}">
                    </div>
                    <div class="col-md-3">
                        <label for="date_to" class="form-label">To Date</label>
                        <input type="date" class="form-control" id="date_to" name="date_to" 
                               value="{{ selected_date_to }}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">&nbsp;</label>
                        <div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-filter"></i> Apply Filters
                            </button>
                            <a href="{{ url_for('transactions') }}" class="btn btn-secondary">
                                <i class="fas fa-times"></i> Clear
                            </a>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- ✅ Transactions List -->
    {% for transaction in transactions %}
    <div class="transaction-row">
        <div class="row align-items-center">
            <div class="col-md-2">
                <i class="bi bi-calendar3"></i>
                {{ transaction.date.strftime('%d %b %Y') }}
            </div>
            <div class="col-md-4">
                <strong>{{ transaction.description }}</strong>
            </div>
            <div class="col-md-2">
                <span class="category-badge" style="background: #e7e9ff; color: #667eea;">
                    {{ transaction.category }}
                </span>
            </div>
            <div class="col-md-2">
                <span class="amount-{{ transaction.transaction_type }}">
                    {% if transaction.transaction_type == 'expense' %}
                    -₹{{ "{:,.2f}".format(transaction.amount) }}
                    {% else %}
                    +₹{{ "{:,.2f}".format(transaction.amount) }}
                    {% endif %}
                </span>
            </div>
            <div class="col-md-2 text-end">
                <a href="{{ url_for('edit_transaction', id=transaction.id) }}" 
                   class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-pencil"></i>
                </a>
                <button onclick="deleteTransaction({{ transaction.id }})" 
                        class="btn btn-sm btn-outline-danger">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>
    </div>
    {% endfor %}

    <!-- Alternative: Using a cleaner approach with URL building -->
    {% macro build_url(page_num) -%}
        ?page={{ page_num }}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if selected_date_from %}&date_from={{ selected_date_from }}{% endif %}{% if selected_date_to %}&date_to={{ selected_date_to }}{% endif %}
    {%- endmacro %}

    <!-- ✅ Pagination with macro -->
    {% if pagination.pages > 1 %}
    <nav class="mt-4">
        <ul class="pagination justify-content-center">
            <!-- First Page -->
            <li class="page-item {{ 'disabled' if pagination.page == 1 else '' }}">
                <a class="page-link" href="{{ build_url(1) }}" aria-label="First">
                    <span aria-hidden="true">&laquo;&laquo;</span>
                </a>
            </li>
            
            <!-- Previous Page -->
            {% if pagination.has_prev %}
            <li class="page-item">
                <a class="page-link" href="{{ build_url(pagination.prev_num) }}" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span> Previous
                </a>
            </li>
            {% else %}
            <li class="page-item disabled">
                <span class="page-link">&laquo; Previous</span>
            </li>
            {% endif %}
            
            <!-- Page Numbers -->
            {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
                {% if page_num %}
                    <li class="page-item {{ 'active' if page_num == pagination.page else '' }}">
                        <a class="page-link" href="{{ build_url(page_num) }}">{{ page_num }}</a>
                    </li>
                {% else %}
                    <li class="page-item disabled">
                        <span class="page-link">...</span>
                    </li>
                {% endif %}
            {% endfor %}
            
            <!-- Next Page -->
            {% if pagination.has_next %}
            <li class="page-item">
                <a class="page-link" href="{{ build_url(pagination.next_num) }}" aria-label="Next">
                    Next <span aria-hidden="true">&raquo;</span>
                </a>
            </li>
            {% else %}
            <li class="page-item disabled">
                <span class="page-link">Next &raquo;</span>
            </li>
            {% endif %}
            
            <!-- Last Page -->
            <li class="page-item {{ 'disabled' if pagination.page == pagination.pages else '' }}">
                <a class="page-link" href="{{ build_url(pagination.pages) }}" aria-label="Last">
                    <span aria-hidden="true">&raquo;&raquo;</span>
                </a>
            </li>
        </ul>
        
        <!-- Page Info -->
        <div class="text-center text-muted mt-2">
            Page {{ pagination.page }} of {{ pagination.pages }} 
            ({{ pagination.total }} total transactions)
        </div>
    </nav>
    {% endif %}
    </div>

<script>
function deleteTransaction(id) {
    if (confirm('Are you sure you want to delete this transaction?')) {
        fetch(`/delete_transaction/${id}`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            }
        }).then(() => {
            location.reload();
        });
    }
}
</script>
{% endblock %}